<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Donation</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://cdn.prod.website-files.com/60dd9083125eb44675d01dba/61484409455df78d536c0980_Food_Connect_favicon.png"
      rel="shortcut icon"
      type="image/x-icon"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      :root {
        --primary: #26634e;
        --primary-dark: #1e5240;
        --secondary: #f68b6a;
        --accent: #85ab30;
        --header-bg: #ffd6c0;
        --body-bg: #fff8f2;
        --text-dark: #333333;
        --text-medium: #555555;
        --text-light: #777777;
        --border-radius: 12px;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--body-bg);
        color: var(--text-dark);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .page-header {
        background-color: var(--header-bg);
        /* padding: 20px 0; */
        box-shadow: var(--shadow);
      }

      .header-content {
        width: 100%;
        /* margin: 0 auto; */
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-content h1 {
        font-size: 32px;
        /* color: var(--primary); */
      }

      #status-badge {
        background-color: #00c2ff;
        color: white;
        padding: 8px 16px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 14px;
      }

      .main-content {
        flex: 1;
        padding: 40px 20px;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }

      .donation-form-container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        margin-top: 20px;
      }

      .form-section {
        flex: 1;
        min-width: 300px;
        background-color: white;
        border-radius: var(--border-radius);
        padding: 25px;
        box-shadow: var(--shadow);
      }

      .image-section {
        flex: 1;
        min-width: 300px;
        background-color: white;
        border-radius: var(--border-radius);
        padding: 25px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
      }

      .section-title {
        font-size: 20px;
        margin-bottom: 20px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title i {
        color: var(--accent);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-medium);
      }

      .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-family: "Poppins", sans-serif;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(133, 171, 48, 0.2);
      }

      .form-input::placeholder {
        color: #bbbbbb;
      }

      .image-upload {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: all 0.3s;
      }

      .image-upload:hover {
        border-color: var(--secondary);
        background-color: rgba(246, 139, 106, 0.05);
      }

      .image-upload i {
        font-size: 48px;
        color: var(--secondary);
        margin-bottom: 15px;
      }

      .image-upload p {
        color: var(--text-light);
      }

      .image-preview {
        display: none;
        max-width: 100%;
        max-height: 300px;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
      }

      .button-container {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: flex-end;
      }

      .btn {
        padding: 15px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-family: "Poppins", sans-serif;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
      }

      .btn-secondary {
        background-color: #f1f1f1;
        color: var(--text-medium);
      }

      .btn-secondary:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
      }

      .info-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
      }

      .info-col {
        flex: 1;
        min-width: 200px;
      }

      .donation-images {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        padding: 24px;
        justify-content: center;
      }

      .donation-images img {
        width: 60%;
        max-width: 300px;
        aspect-ratio: 1/1;
        object-fit: cover;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
      }

      @media (max-width: 768px) {
        .donation-form-container {
          flex-direction: column;
        }

        .info-row {
          flex-direction: column;
          gap: 10px;
        }

        .button-container {
          flex-direction: column;
        }
      }
    </style>
    <!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>

  <style>
    #map {
      height: 500px;
      width: 100%;
    }
  </style>
  </head>
  <body>
    <header class="page-header">
      <div class="header-content">
        <h1 id="page-title">Create Donation</h1>
        <div id="status-badge" style="display: none;">AVAILABLE</div>
      </div>
    </header>

    <main class="main-content">
      <form id="donation-form">
        <div class="donation-form-container">
          <div class="form-section">
            <h2 class="section-title">
              <i class="fas fa-box-open"></i> Item Details
            </h2>

            <div class="info-row">
              <div class="info-col">
                <div class="form-group">
                  <label for="itemName" class="form-label">Item Name</label>
                  <input
                    type="text"
                    id="itemName"
                    name="itemName"
                    class="form-input"
                    placeholder="Enter food item name"
                    required
                  />
                </div>
              </div>

              <div class="info-col">
                <div class="form-group">
                  <label for="quantity" class="form-label">Quantity</label>
                  <input
                    type="number"
                    id="quantity"
                    name="quantity"
                    class="form-input"
                    placeholder="Enter quantity"
                    required
                  />
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="bestBeforeDate" class="form-label"
                >Best Before Date</label
              >
              <input
                type="date"
                id="bestBeforeDate"
                name="bestBeforeDate"
                class="form-input"
                required
              />
            </div>

            <h2 class="section-title" style="margin-top: 30px">
              <i class="fas fa-map-marker-alt"></i> Pickup Information
            </h2>

            <div class="form-group">
              <label for="pickupLocation" class="form-label"
                >Pickup Location</label
              >
              <input
                type="text"
                id="pickupLocation"
                name="pickupLocation"
                class="form-input"
                placeholder="Enter street address"
                required
              />
            </div>

            <div class="info-row">
              <div class="info-col">
                <div class="form-group">
                  <label for="availabilityStart" class="form-label"
                    >Available From</label
                  >
                  <input
                    type="datetime-local"
                    id="availabilityStart"
                    name="availabilityStart"
                    class="form-input"
                    required
                  />
                </div>
              </div>

              <div class="info-col">
                <div class="form-group">
                  <label for="availabilityEnd" class="form-label"
                    >Available Until</label
                  >
                  <input
                    type="datetime-local"
                    id="availabilityEnd"
                    name="availabilityEnd"
                    class="form-input"
                    required
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="image-section">
            <h2 class="section-title">
              <i class="fas fa-image"></i> Donation Image
            </h2>

            <div
              class="donation-images"
              id="donation-images"
              style="display: none"
            ></div>

            <div class="image-upload" id="image-upload">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Click or drag an image here to upload</p>
              <input
                type="file"
                id="donationImage"
                name="donationImage"
                accept="image/*"
                style="
                  opacity: 0;
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  cursor: pointer;
                "
              />
            </div>
            <img
              id="imagePreview"
              class="image-preview"
              alt="Donation Image Preview"
            />
          </div>
        </div>

        <div class="button-container">
          <button type="button" class="btn btn-secondary" id="back-button">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button type="submit" class="btn btn-primary" id="create-button">
            <i class="fas fa-plus-circle"></i> Create Donation
          </button>
        </div>
      </form>
  
     <h1>Select Donation Location</h1>
  <div id="map"></div>

  <!-- Hidden inputs for latitude and longitude -->
  <form id="donationForm" action="/donations" method="POST">
    <input type="hidden" id="latitude" name="latitude" />
    <input type="hidden" id="longitude" name="longitude" />
    <!-- Other form inputs like donation details -->
    <button type="submit">Submit Donation</button>
  </form>

    </main>

 <script>
  var map = L.map('map').setView([19.0760, 72.8777], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

  var marker = L.marker([19.0760, 72.8777]).addTo(map);
  marker.bindPopup("Default Location: Mumbai").openPopup();

  if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    function (position) {
      var lat = position.coords.latitude;
      var lng = position.coords.longitude;

      console.log("📍 User's Current Location:");
      console.log("Latitude: " + lat);
      console.log("Longitude: " + lng);

      // Clear the default marker
      map.eachLayer(function (layer) {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });

      // Recenter the map and add marker
      map.setView([lat, lng], 15);

      L.marker([lat, lng])
        .addTo(map)
        .bindPopup("You are here")
        .openPopup();
    },
    function (error) {
      console.error("❌ Geolocation error: " + error.message);
    },
    {
      enableHighAccuracy: true,   // This helps with GPS-level accuracy
      timeout: 10000,
      maximumAge: 0
    }
  );
} else {
  alert("Geolocation is not supported by your browser.");
}


  var donationMarker;

  map.on('click', function (e) {
    var lat = e.latlng.lat;
    var lng = e.latlng.lng;

    console.log("📌 Clicked on map:");
    console.log("Latitude: " + lat);
    console.log("Longitude: " + lng);

    if (donationMarker) {
      map.removeLayer(donationMarker);
    }

    donationMarker = L.marker([lat, lng]).addTo(map);

    // If you have input fields with these IDs
    var latInput = document.getElementById('latitude');
    var lngInput = document.getElementById('longitude');

    if (latInput && lngInput) {
      latInput.value = lat;
      lngInput.value = lng;
    }
  });
</script>


    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        console.log(token);

        if (!token) {
          // Store the URL the user was trying to access
          localStorage.setItem("redirectAfterLogin", window.location.href);
          // Redirect to signin page
          window.location.href = "not-logged-in.html";
        } else {
          document.body.style.display = "flex"; // Show page if logged in
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("donation-images");
        const token = localStorage.getItem("token");
        console.log(token);
        const urlParams = new URLSearchParams(window.location.search);
        const donationId = urlParams.get("donationId");
        console.log(donationId);
        const form = document.getElementById("donation-form"); // ✅ move this up
        const url = donationId
          ? `http://localhost:8080/donations/${donationId}`
          : "http://localhost:8080/donations";

        const method = donationId ? "PUT" : "POST";

        function getImage() {
          photoUrl = `http://localhost:8080${donation.photoUrl}`;

          // Load donation image
          const images = Array.isArray(donation.photoUrls)
            ? donation.photoUrls
            : [donation.photoUrl]; // for backward compatibility
          loadImages(images);
        }

        if (donationId) {
          document.title = "Update Donation";
          document.getElementById("page-title").textContent = "Update Donation";
          document.getElementById("create-button").innerHTML =
            '<i class="fas fa-save"></i> Update Donation';
          document.getElementById("status-badge").style.display = "flex";

          fetch(`http://localhost:8080/donations/${donationId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((res) => res.json())
            .then((donation) => {
              document.getElementById("itemName").value = donation.itemName;
              document.getElementById("quantity").value = donation.quantity;
              document.getElementById("bestBeforeDate").value =
                donation.bestBeforeDate;
              document.getElementById("pickupLocation").value =
                donation.pickupLocation;
              document.getElementById("availabilityStart").value =
                donation.availabilityStart.slice(0, 16);
              document.getElementById("availabilityEnd").value =
                donation.availabilityEnd.slice(0, 16);

              // Optional: If your API sends image URL
              if (donation.photoUrl) {
                container.innerHTML = ""; // Clear old images
                const placeholder = document.createElement("div");
                placeholder.className = "image-placeholder";
                placeholder.innerHTML =
                  '<i class="fa fa-spinner fa-spin"></i><p>Loading...</p>';
                container.appendChild(placeholder);

                fetch(`http://localhost:8080${donation.photoUrl}`, {
                  headers: {
                    Authorization: `Bearer ${token}`,
                  },
                })
                  .then((response) => {
                    if (!response.ok) throw new Error("Image fetch failed");
                    return response.blob();
                  })
                  .then((blob) => {
                    document.getElementById("donation-images").style.display =
                      "flex";
                    const img = document.createElement("img");
                    img.src = URL.createObjectURL(blob);
                    img.alt = "Donation Image";
                    img.onload = () => {
                      container.replaceChild(img, placeholder);
                    };
                    img.onerror = () => {
                      placeholder.innerHTML =
                        '<i class="fa fa-exclamation-circle"></i><p>Failed to load image</p>';
                    };
                  });
              }
            })
            .catch((err) => console.error("Error loading donation:", err));
        }

        // Image preview
        const donationImage = document.getElementById("donationImage");
        const imagePreview = document.getElementById("imagePreview");

        donationImage.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              imagePreview.src = e.target.result;
              imagePreview.style.display = "block";
            };
            reader.readAsDataURL(file);
          }
        });

        // ✅ Form submission logic
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          function padZero(n) {
            return n < 10 ? "0" + n : n;
          }

          function formatWithSeconds(dateTimeInputValue) {
            // If already has seconds, leave it
            if (dateTimeInputValue.length === 19) return dateTimeInputValue;

            // Otherwise, add ":00" for seconds
            return dateTimeInputValue + ":00";
          }

          const donationData = {
            itemName: document.getElementById("itemName").value,
            quantity: document.getElementById("quantity").value,
            bestBeforeDate: document.getElementById("bestBeforeDate").value,
            pickupLocation: document.getElementById("pickupLocation").value,
            availabilityStart: formatWithSeconds(
              document.getElementById("availabilityStart").value
            ),
            availabilityEnd: formatWithSeconds(
              document.getElementById("availabilityEnd").value
            ),
          };

          const formData = new FormData();

          // Send JSON as string under donationRequest
          formData.append("donationRequest", JSON.stringify(donationData));

          // Append image if exists
          const imageInput = document.getElementById("donationImage");
          if (imageInput.files.length > 0) {
            formData.append("image", imageInput.files[0]);
          }

          try {
            const token = localStorage.getItem("token"); // or however you're storing it

            const response = await fetch(url, {
              method: method,
              headers: {
                Authorization: `Bearer ${token}`,
                // DO NOT set Content-Type manually! Let the browser do it for multipart/form-data
              },
              body: formData,
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `Server responded with ${response.status}: ${errorText}`
              );
            }

            const data = await response.json();
            if (donationId) {
              console.log(donationId);
              alert("Donation updated successfully!");
              window.location.href = `donation-details.html?id=${donationId}`;
            } else {
              alert("Donation created successfully!");
            }
          } catch (error) {
            console.error("Error submitting donation:", error);
            alert("Error submitting donation. Check the console for details.");
          }
        });
      });

      // Back button (optional)
      const backButton = document.getElementById("back-button");
      backButton.addEventListener("click", () => {
        window.history.back(); // Takes user to the previous page
      });
    </script>
  </body>
</html>
