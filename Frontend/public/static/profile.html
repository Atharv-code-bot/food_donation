<!DOCTYPE html>
<!-- This site was created in Webflow. https://www.webflow.com --><!-- Last Published: Fri Jul 01 2022 10:10:03 GMT+0000 (Coordinated Universal Time) -->
<html
  data-wf-domain="dash-template.webflow.io"
  data-wf-page="6059ece1eaca7a7e52dfa1bd"
  data-wf-site="6057ab51530cb39d3fdac75d"
>
  <head>
    <meta charset="utf-8" />
    <title>Profile</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <!-- <link
      href="https://assets.website-files.com/6057ab51530cb39d3fdac75d/css/dash-template.webflow.dda81817a.css"
      rel="stylesheet"
      type="text/css"
    /> -->
    <link rel="stylesheet" href="../styles/profile.css" />
    <link
      href="https://cdn.prod.website-files.com/60dd9083125eb44675d01dba/61484409455df78d536c0980_Food_Connect_favicon.png"
      rel="shortcut icon"
      type="image/x-icon"
    />
    <script
      src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"
      type="text/javascript"
    ></script>
    <script type="text/javascript">
      WebFont.load({ google: { families: ["Inter:regular,500,600,700"] } });
    </script>
    <!--[if lt IE 9
      ]><script
        src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"
        type="text/javascript"
      ></script
    ><![endif]-->
    <script type="text/javascript">
      !(function (o, c) {
        var n = c.documentElement,
          t = " w-mod-";
        (n.className += t + "js"),
          ("ontouchstart" in o ||
            (o.DocumentTouch && c instanceof DocumentTouch)) &&
            (n.className += t + "touch");
      })(window, document);
    </script>
    <!-- <link
      href="https://assets.website-files.com/6057ab51530cb39d3fdac75d/608954b07e50af32f41306b7_Dash%20Favicon%20Small.png"
      rel="shortcut icon"
      type="image/x-icon"
    /> -->
    <!-- <link
      href="https://assets.website-files.com/6057ab51530cb39d3fdac75d/608954b52729362300b39dc9_Dash%20Logo.png"
      rel="apple-touch-icon"
    /> -->
    <style>
      body {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div
        data-collapse="medium"
        data-animation="default"
        data-duration="400"
        data-easing="ease"
        data-easing2="ease"
        role="banner"
        class="dashboard-sidebar w-nav"
      >
        <div class="mobile-bar">
          <div class="mobile-bar-menu">
            <a href="#" class="mobile-bar-link w-inline-block"
              ><img
                src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/60586b1639502416b88ec95a_home%20(2).svg"
                loading="lazy"
                alt="" /></a
            ><a href="#" class="mobile-bar-link w-inline-block"
              ><img
                src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/6058703e233c35f06d95eeab_Projects.svg"
                loading="lazy"
                alt="" /></a
            ><a
              data-w-id="da3d71f2-0efd-7bc8-77ff-08fc09cd7904"
              href="#"
              class="mobile-menu-button w-inline-block"
              ><div
                data-is-ix2-target="1"
                class="lottie-menu-icon"
                data-w-id="da3d71f2-0efd-7bc8-77ff-08fc09cd7905"
                data-animation-type="lottie"
                data-src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/60587725e051a2be05473dcc_Lottie%20Menu%20Animation.json"
                data-loop="0"
                data-direction="1"
                data-autoplay="0"
                data-renderer="svg"
                data-default-duration="2"
                data-duration="0"
                data-ix2-initial-state="0"
              ></div></a
            ><a href="#" class="mobile-bar-link w-inline-block"
              ><img
                src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/6058703e3a273545cf97d31b_Profile.svg"
                loading="lazy"
                alt="" /></a
            ><a href="#" class="mobile-bar-link w-inline-block"
              ><img
                src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/6058703ecc16b10bf2981896_Settings.svg"
                loading="lazy"
                alt=""
            /></a>
          </div>
        </div>
      </div>
      <div class="dashboard-banner">
        <div class="dashboard-banner-header">
          <div class="breadcrumb-wrapper">
            <div class="breadcrumb-item">
              <a
                class="breadcrumb-text w-inline-block back-button"
                id="back-button"
                >Dashboard</a
              ><img
                src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/618291022450e8b448680ed1_chevron-right.svg"
                loading="lazy"
                alt=""
                class="breacrumb-chevron"
              />
            </div>
            <div class="breadcrumb-item">
              <div class="breadcrumb-text">Account</div>
            </div>
          </div>
          <div class="header-content">
            <a
              aria-current="page"
              class="banner-avatar-wrapper w-inline-block w--current"
              ><img
                src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/605b3cfa3d1f8120bfc88c26_Dash%20-%20Avatar%2002-min.jpg"
                loading="lazy"
                alt=""
                class="banner-avatar-image"
              />
              <div>
                <h5 class="banner-avatar-name">Jennifer H.</h5>
                <div class="banner-avatar-caption">Account settings</div>
              </div></a
            >
          </div>
        </div>
      </div>
      <div class="dashboard-content">
        <div class="utility-container">
          <div
            data-duration-in="300"
            data-duration-out="100"
            data-current="General"
            data-easing="ease"
            class="w-tabs"
          >
            <!-- <div class="in-page-menu w-tab-menu">
              <a
                data-w-tab="General"
                class="in-page-menu-link w-inline-block w-tab-link w--current"
                ><div>General</div></a
              ><a
                data-w-tab="Billing"
                class="in-page-menu-link w-inline-block w-tab-link"
                ><div>Billing</div></a
              ><a
                data-w-tab="Security"
                class="in-page-menu-link w-inline-block w-tab-link"
                ><div>Security</div></a
              >
            </div> -->
            <div class="tabs-content w-tab-content">
              <div data-w-tab="General" class="w-tab-pane w--tab-active">
                <div class="account">
                  <div class="user-details">
                    <img
                      loading="lazy"
                      src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/605b3cfa3d1f8120bfc88c26_Dash%20-%20Avatar%2002-min.jpg"
                      alt=""
                      class="user-avatar"
                    />
                    <div>
                      <h5 class="no-space-bottom">Your Avatar</h5>
                      <div class="small-text text-grey-3">
                        Profile picture size: 400px x 400px
                      </div>
                    </div>
                  </div>
                  <a
                    href="#"
                    id="upload-avatar-btn"
                    class="button button-small button-outline w-button"
                    >Upload new avatar</a
                  >
                  <!-- Hidden File Input -->
                  <input
                    type="file"
                    id="avatar-input"
                    accept="image/*"
                    style="display: none"
                  />
                </div>
                <div class="w-form">
                  <form
                    id="wf-form-Form"
                    name="wf-form-Form"
                    data-name="Form"
                    method="get"
                  >
                    <div class="w-layout-grid form-grid space-bottom-small">
                      <div>
                        <h6>Username</h6>
                        <input
                          type="text"
                          class="text-field w-input"
                          maxlength="256"
                          name="username"
                          data-name="First name"
                          placeholder=""
                          id="username"
                          required=""
                          disabled
                        />
                      </div>

                      <div>
                        <h6>Address</h6>
                        <input
                          type="text"
                          class="text-field w-input"
                          maxlength="256"
                          name="address"
                          data-name="address"
                          placeholder=""
                          id="address"
                          required=""
                          disabled
                        />
                      </div>
                      <div>
                        <h6>Phone</h6>
                        <input
                          type="tel"
                          class="text-field w-input"
                          maxlength="256"
                          name="Phone"
                          data-name="Phone"
                          placeholder="+123 456 7890"
                          id="Phone"
                          disabled
                        />
                      </div>
                      <div>
                        <h6>Fullname</h6>
                        <input
                          type="text"
                          class="text-field w-input"
                          maxlength="256"
                          name="fullname"
                          data-name="Phone"
                          id="fullname"
                          disabled
                        />
                      </div>
                      <div>
                        <h6>Email Address</h6>
                        <div class="form-caption">
                          Verification purposes only
                        </div>
                        <input
                          type="email"
                          class="text-field w-input"
                          maxlength="256"
                          name="Email-Address"
                          data-name="Email Address"
                          placeholder=""
                          id="Email-Address"
                          required=""
                          disabled
                        />
                      </div>
                      <div id="password-wrapper" style="display: none">
                        <h6>Current Password</h6>
                        <div class="form-caption">
                          Verification purposes only
                        </div>
                        <input
                          type="password"
                          id="password"
                          class="text-field w-input"
                          placeholder="Enter your password"
                        />
                      </div>
                    </div>
                    <div id="button-container">
                      <button
                        type="button"
                        id="editBtn"
                        class="button button-small w-button"
                      >
                        Edit details
                      </button>

                      <div id="actionBtns" style="display: none">
                        <button
                          type="submit"
                          class="button button-small w-button"
                        >
                          Save changes
                        </button>
                        <button
                          type="button"
                          class="button button-small w-button"
                          onclick="cancelEdit()"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>

                    <!-- New buttons: hidden by default -->
                    <div
                      id="edit-actions"
                      style="display: none; margin: 10px 0px"
                    >
                      <button
                        type="button"
                        class="button button-small"
                        id="cancel-btn"
                      >
                        Cancel
                      </button>
                      <button
                        type="submit"
                        class="button button-small"
                        id="save-btn"
                      >
                        Save changes
                      </button>
                    </div>
                  </form>
                  <div class="form-success w-form-done" style="display: none">
                    <div>Profile details succesfully updated!</div>
                  </div>
                  <div class="form-error w-form-fail" style="display: none">
                    <div>
                      Please check the password you entered and try again.
                    </div>
                  </div>
                </div>
                <div class="account-divider"></div>
                <div class="w-layout-grid _2-grid">
                  <div class="content-width-small">
                    <div class="space-bottom">
                      <h4>Change password</h4>
                      <div class="form-caption">
                        You can always change your password for security reasons
                        or reset your password in case you forgot it.
                      </div>
                    </div>
                    <a
                      href="/authentication/password-reset"
                      class="button button-small button-outline w-button"
                      >Forgot password?</a
                    >
                  </div>
                  <div class="form-wrap w-form">
                    <form
                      id="wf-form-Form-pass"
                      name="wf-form-Form"
                      data-name="Form"
                      method="get"
                    >
                      <div class="w-layout-grid password-reset-grid">
                        <div>
                          <h6>Current password</h6>
                          <input
                            type="password"
                            class="text-field w-input"
                            maxlength="256"
                            name="Current-Password"
                            data-name="Current Password"
                            placeholder=""
                            id="Current-Password"
                            required=""
                          />
                        </div>
                        <div>
                          <h6>New pasword</h6>
                          <input
                            type="password"
                            class="text-field w-input"
                            maxlength="256"
                            name="New-password"
                            data-name="New password"
                            placeholder=""
                            id="New-password"
                            required=""
                          />
                        </div>
                        <div>
                          <h6>Confirm new password</h6>
                          <input
                            type="password"
                            class="text-field w-input"
                            maxlength="256"
                            name="Comfirm-Password"
                            data-name="Comfirm Password"
                            placeholder=""
                            id="Comfirm-Password"
                            required=""
                          />
                        </div>
                        <input
                          type="submit"
                          value="Update password"
                          data-wait="Please wait..."
                          class="button button-small w-button"
                        />
                      </div>
                    </form>
                    <div
                      class="form-success w-form-done-pass"
                      style="display: none"
                    >
                      <div>Password was succesfully changed.</div>
                    </div>
                    <div
                      class="form-error w-form-fail-pass"
                      style="display: none"
                    >
                      <div>Oops! Something went wrong.</div>
                    </div>
                  </div>
                </div>
                <div class="account-delete">
                  <div class="content-width-small space-bottom-small">
                    <h6>Logout</h6>
                    <div class="form-caption">
                      If you logout your account, You will need to log in again
                      to access your account.
                    </div>
                  </div>
                  <button
                    onclick="logout()"
                    class="button button-small w-button"
                    style="background-color: rgb(252, 68, 68)"
                  >
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="mobile-bottom-spacing"></div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        console.log(token);

        if (!token) {
          // Store the URL the user was trying to access
          localStorage.setItem("redirectAfterLogin", window.location.href);
          // Redirect to signin page
          window.location.href = "not-logged-in.html";
        } else {
          document.body.style.display = "block"; // Show page if logged in
        }
      });
    </script>
    <script
      src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=6057ab51530cb39d3fdac75d"
      type="text/javascript"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <!-- <script
      src="https://assets.website-files.com/6057ab51530cb39d3fdac75d/js/webflow.2e6c70b30.js"
      type="text/javascript"
    ></script> -->
    <script>
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        localStorage.removeItem("id");
        window.location.href = "home.html"; // Redirect to login page
      }
    </script>
    <script>
      const backButton = document.getElementById("back-button");
      backButton.addEventListener("click", () => {
        window.history.back(); // Takes user to the previous page
      });
    </script>
    <!-- <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("token");
        const avatarImg = document.querySelector(".user-avatar");

        // 1. Fetch current user and update image src
        try {
          const response = await fetch("http://localhost:8080/users/current", {
            headers: {
              Authorization: "Bearer " + token,
            },
          });

          const userData = await response.json();
          if (userData.photoUrl) {
            avatarImg.src = `http://localhost:8080/${userData.photoUrl}`;
          }
        } catch (err) {
          console.error("Failed to fetch user info:", err);
        }

        // 2. Add a hidden file input for image upload
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.style.display = "none";
        document.body.appendChild(fileInput);

        // 3. Handle "Upload new avatar" button click
        const uploadButton = document.querySelector(".button-outline");
        uploadButton.addEventListener("click", function (e) {
          e.preventDefault();
          fileInput.click();
        });

        let selectedFile = null;

        fileInput.addEventListener("change", () => {
          if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];

            const reader = new FileReader();
            reader.onload = (e) => {
              avatarImg.src = e.target.result;

              // Auto-submit updated profile with only image changed
              updateUserProfile(token, selectedFile, role);
            };
            reader.readAsDataURL(selectedFile);
          }
        });

        // 4. Handle user update with image upload
        document
          .getElementById("update-profile-button")
          .addEventListener("click", async function () {
            const userData = {
              username: document.getElementById("username").value,
              email: document.getElementById("Email-Address").value,
              phone: document.getElementById("Phone").value,
              fullname: document.getElementById("fullname").value,
              address: document.getElementById("address").value,
              // add other fields if needed
            };

            const formData = new FormData();
            formData.append(
              "userRequest",
              new Blob([JSON.stringify(userData)], { type: "application/json" })
            );
            if (selectedFile) {
              formData.append("image", selectedFile);
            }

            try {
              console.log("Sending update:", JSON.stringify(formData, null, 2));
              const response = await fetch(
                "http://localhost:8080/users/update",
                {
                  method: "PUT",
                  headers: {
                    Authorization: "Bearer " + token,
                  },
                  body: formData,
                }
              );

              if (response.ok) {
                alert("Profile updated successfully!");
                window.location.reload();
              } else {
                const errorText = await response.text();
                console.error("Update failed:", errorText);
                alert("Failed to update profile.");
              }
            } catch (error) {
              console.error("Error updating user:", error);
              alert("Something went wrong!");
            }
          });
      });
    </script> -->

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const bannerName = document.querySelector(".banner-avatar-name");
        const form = document.getElementById("wf-form-Form");
        const editBtn = document.getElementById("editBtn");
        const cancelBtn = document.getElementById("cancel-btn");
        const saveBtn = document.getElementById("save-btn");
        const editActions = document.getElementById("edit-actions");
        const passwordWrapper = document.getElementById("password-wrapper");
        const emailInput = document.getElementById("Email-Address");

        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");

        const avatarImg = document.querySelectorAll(
          ".user-avatar, .banner-avatar-image"
        );
        const uploadBtn = document.getElementById("upload-avatar-btn");
        const fileInput = document.getElementById("avatar-input");

        const inputs = form.querySelectorAll(
          "input[type='text'], input[type='email'], input[type='tel']"
        );
        const originalValues = {};
        let selectedFile = null;

        // Email masking function
        const maskEmail = (email) => {
          const [user, domain] = email.split("@");
          const visible = user.slice(0, 3);
          return visible + "*".repeat(user.length - 3) + "@" + domain;
        };

        // Fetch and populate data
        fetch("http://localhost:8080/users/current", {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("username").value = data.username;
            document.getElementById("address").value = data.address;
            document.getElementById("Phone").value = data.phone;
            document.getElementById("fullname").value = data.fullname;
            emailInput.value = maskEmail(data.email);
            bannerName.innerHTML = data.fullname;

            originalValues.username = data.username;
            originalValues.address = data.address;
            originalValues.Phone = data.phone;
            originalValues.fullname = data.fullname;
            originalValues.email = data.email;

            // Show user profile image securely with token
            if (data.photoUrl) {
              fetch(`http://localhost:8080${data.photoUrl}`, {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              })
                .then((res) => {
                  if (!res.ok) throw new Error("Image fetch failed");
                  return res.blob();
                })
                .then((blob) => {
                  const blobUrl = URL.createObjectURL(blob);
                  avatarImg.forEach((img) => {
                    img.src = blobUrl;
                  });
                })
                .catch((err) => {
                  console.error("Error loading profile image:", err);
                  avatarImg.src = "fallback.png"; // optional fallback image
                });
            }
          });

        const toggleInputs = (disabled) => {
          inputs.forEach((input) => (input.disabled = disabled));
        };

        // Upload avatar handler
        uploadBtn.addEventListener("click", (e) => {
          e.preventDefault();
          fileInput.click();
        });

        fileInput.addEventListener("change", () => {
          if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];

            const reader = new FileReader();
            reader.onload = (e) => {
              avatarImg.src = e.target.result;

              // Auto-submit updated profile with only image changed
              updateUserProfile(token, selectedFile, role);
            };
            reader.readAsDataURL(selectedFile);
          }
        });

        // Edit button
        editBtn.addEventListener("click", () => {
          toggleInputs(false);
          emailInput.value = originalValues.email;
          passwordWrapper.style.display = "block";
          editBtn.style.display = "none";
          editActions.style.display = "flex";
          editActions.style.gap = "10px";
        });

        // Cancel button
        cancelBtn.addEventListener("click", () => {
          document.getElementById("username").value = originalValues.username;
          document.getElementById("address").value = originalValues.address;
          document.getElementById("Phone").value = originalValues.Phone;
          document.getElementById("fullname").value = originalValues.fullname;
          emailInput.value = maskEmail(originalValues.email);
          document.getElementById("password").value = "";
          toggleInputs(true);
          passwordWrapper.style.display = "none";
          editActions.style.display = "none";
          editBtn.style.display = "inline-block";
          selectedFile = null; // cancel any selected file
        });

        // Submit (save)
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          updateUserProfile(token, selectedFile, role);
        });
      });

      async function updateUserProfile(
        token,
        selectedFile,
        role,
        originalValues
      ) {
        const edit_actions = document.getElementById("edit-actions");
        const emailInput = document.getElementById("Email-Address");
        const updatedData = {
          username: document.getElementById("username").value,
          address: document.getElementById("address").value,
          phone: document.getElementById("Phone").value,
          fullname: document.getElementById("fullname").value,
          email: emailInput.value,
          password: document.getElementById("password")?.value || "",
          role: role,
        };

        const formData = new FormData();
        formData.append("userRequest", JSON.stringify(updatedData));
        if (selectedFile) {
          formData.append("image", selectedFile);
        }
        const plainObject = {};
        formData.forEach((value, key) => {
          plainObject[key] = value;
        });

        console.log("Sending update:", JSON.stringify(plainObject, null, 2));

        try {
          const response = await fetch("http://localhost:8080/users/update", {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          if (!response.ok) {
            const errText = await response.text();
            throw new Error(errText);
          }

          alert("Profile updated successfully!");
          document.querySelector(".w-form-done").style.display = "block";
          document.querySelector(".w-form-fail").style.display = "none";
          edit_actions.style.display = "none";
          setTimeout(() => location.reload(), 3000);
        } catch (error) {
          console.error("Error updating user:", error);
          alert("Failed to update user.");
          document.querySelector(".w-form-done").style.display = "none";
          document.querySelector(".w-form-fail").style.display = "block";
        }
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const passForm = document.getElementById("wf-form-Form-pass");
        const currentPasswordInput =
          document.getElementById("Current-Password");
        const newPasswordInput = document.getElementById("New-password");
        const confirmPasswordInput =
          document.getElementById("Comfirm-Password");
        const failForm = document.querySelector(".w-form-fail-pass");

        passForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          if (newPassword !== confirmPassword) {
            failForm.style.display = "block";
            failForm.innerHTML =
              "<div>New password and confirmation do not match.</div>";
            return;
          }

          try {
            const response = await fetch(
              "http://localhost:8080/users/password-change",
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem("token")}`, // replace with actual token retrieval
                },
                body: JSON.stringify({
                  currentPassword:
                    document.getElementById("Current-Password").value,
                  newPassword: document.getElementById("New-password").value,
                }),
              }
            );

            let message = "Password updated successfully!";
            if (!response.ok) {
              const contentType = response.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                const errorData = await response.json();
                message = errorData.message || "Password update failed.";
              } else {
                const errorText = await response.text(); // it's plain text
                message = errorText || "Password update failed.";
              }
              throw new Error(message);
            }

            alert(message);

            // Success
            document.querySelector(".w-form-done-pass").style.display = "block";
            document.querySelector(".w-form-fail-pass").style.display = "none";
            alert("Password updated successfully!");
            passForm.reset();
          } catch (error) {
            console.error("Error:", error);
            document.querySelector(".w-form-done-pass").style.display = "none";
            failForm.innerHTML = "<div>Password entered is wrong.</div>";
            document.querySelector(".w-form-fail-pass").style.display = "block";
            alert("Error updating password: " + error.message);
          }
        });
      });
    </script>

    <!--[if lte IE 9
      ]><script src="//cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script
    ><![endif]-->
  </body>
</html>
