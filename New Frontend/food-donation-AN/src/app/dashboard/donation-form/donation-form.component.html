<div class="min-h-screen bg-gradient-to-b from-green-50 to-white">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-green-100 p-4">
    <div class="max-w-9xl mx-auto flex justify-between items-center">
      <h1 class="text-2xl md:text-3xl font-bold text-green-800">
        {{ mode === "create" ? "Create Donation" : "Edit Donation" }}
      </h1>
      <div
        class="px-4 py-1 rounded-full text-sm font-medium capitalize"
        [class.bg-green-100]="mode === 'create'"
        [class.text-green-800]="mode === 'create'"
        [class.bg-green-100]="donation?.status === 'AVAILABLE'"
        [class.text-green-800]="donation?.status === 'AVAILABLE'"
        [class.bg-yellow-100]="donation?.status === 'CLAIMED'"
        [class.text-yellow-800]="donation?.status === 'CLAIMED'"
        [class.bg-blue-100]="donation?.status === 'COLLECTED'"
        [class.text-blue-800]="donation?.status === 'COLLECTED'"
      >
        {{ mode === "create" ? "NEW" : donation?.status }}
      </div>
    </div>
  </header>

  <p-dialog
    *ngIf="mode === 'create'"
    header="ðŸŽ‰ Thank You!"
    [(visible)]="showSuccessDialog"
    modal="true"
    [closable]="false"
    [style]="{ width: '90%', maxWidth: '400px' }"
    class="rounded-lg"
  >
    <div class="text-center space-y-4">
      <img
        src="https://cdn-icons-png.flaticon.com/512/2278/2278992.png"
        alt="Success"
        class="w-24 h-24 mx-auto"
      />
      <h3 class="text-xl font-semibold text-green-600">Donation Created!</h3>
      <p class="text-gray-700">Thank you for your donation. It means a lot!</p>
      <button
        pButton
        label="Go to Dashboard"
        class="p-button-success"
        (click)="navigateToDashboard()"
      ></button>
    </div>
  </p-dialog>

  <p-dialog
    header="âœ… Update Successful"
    [(visible)]="showSuccessDialog"
    *ngIf="mode === 'update'"
    modal="true"
    [closable]="false"
    [style]="{ width: '90%', maxWidth: '400px' }"
    class="rounded-lg"
  >
    <div class="text-center space-y-4 p-4">
      <img
        src="https://cdn-icons-png.flaticon.com/512/190/190411.png"
        alt="Update Success"
        class="w-20 h-20 mx-auto"
      />
      <h3 class="text-xl font-semibold text-green-600">Donation Updated!</h3>
      <p class="text-gray-700">Your donation has been successfully updated.</p>
      <button
        pButton
        label="Go to Dashboard"
        class="p-button-success"
        (click)="navigateToDashboard()"
      ></button>
    </div>
  </p-dialog>

  <!-- Main Form Content -->
  <div class="max-w-7xl mx-auto p-4">
    <form
      [formGroup]="form"
      (ngSubmit)="onSubmit()"
      class="bg-white rounded-lg shadow-sm border border-green-100 p-6"
    >
      <div class="grid lg:grid-cols-2 gap-8">
        <!-- Left Column - Form Fields -->
        <div class="space-y-6">
          <!-- Item Details Section -->
          <div>
            <h2
              class="flex items-center gap-2 text-xl font-semibold text-green-700 mb-4"
            >
              <lucide-icon
                name="package"
                class="h-5 w-5 text-green-600"
              ></lucide-icon>
              Item Details
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="form-group">
                <label
                  for="itemName"
                  class="block text-lg font-medium text-green-800 mb-1"
                  >Item Name</label
                >
                <input
                  type="text"
                  id="itemName"
                  class="w-full p-2 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400"
                  placeholder="Enter food item name"
                  formControlName="itemName"
                  required
                />
              </div>

              <div class="form-group">
                <label
                  for="quantity"
                  class="block text-lg font-medium text-green-800 mb-1"
                  >Quantity</label
                >
                <input
                  type="number"
                  id="quantity"
                  class="w-full p-2 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400"
                  placeholder="Enter quantity"
                  formControlName="quantity"
                  min="1"
                  required
                />
              </div>
            </div>

            <div class="form-group mt-4">
              <label
                for="bestBeforeDate"
                class="block text-lg font-medium text-green-800 mb-1"
                >Best Before Date</label
              >
              <input
                type="date"
                id="bestBeforeDate"
                class="w-full p-2 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400"
                formControlName="bestBeforeDate"
                placeholder="Select best before date"
                required
              />
            </div>
          </div>

          <!-- Pickup Information Section -->
          <div>
            <h2
              class="flex items-center gap-2 text-xl font-semibold text-green-700 mb-4"
            >
              <lucide-icon
                name="map-pin"
                class="h-5 w-5 text-green-600"
              ></lucide-icon>
              Pickup Information
            </h2>

            <div class="form-group">
              <label
                for="pickupLocation"
                class="block text-lg font-medium text-green-800 mb-1"
                >Pickup Location</label
              >
              <input
                type="text"
                id="pickupLocation"
                class="w-full p-2 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400"
                placeholder="Enter street address"
                formControlName="pickupLocation"
                required
              />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div class="form-group">
                <label
                  for="availabilityStart"
                  class="block text-lg font-medium text-green-800 mb-1"
                  >Available From</label
                >
                <input
                  type="datetime-local"
                  id="availabilityStart"
                  class="w-full p-2 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400"
                  formControlName="availabilityStart"
                  placeholder="Select start date and time"
                  required
                />
              </div>

              <div class="form-group">
                <label
                  for="availabilityEnd"
                  class="block text-lg font-medium text-green-800 mb-1"
                  >Available Until</label
                >
                <input
                  type="datetime-local"
                  id="availabilityEnd"
                  class="w-full p-2 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400"
                  formControlName="availabilityEnd"
                  placeholder="Select end date and time"
                  required
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Image Upload -->
        <div class="space-y-6">
          <h2
            class="flex items-center gap-2 text-xl font-semibold text-green-700 mb-4"
          >
            <lucide-icon
              name="image"
              class="h-5 w-5 text-green-600"
            ></lucide-icon>
            Donation Image
          </h2>

          <!-- File Upload -->
          <label class="block text-lg font-medium text-green-800 mb-2"
            >Upload New Image</label
          >
          <div class="bg-green-50 rounded-lg border border-green-100 p-4">
            <p-fileUpload
              mode="basic"
              name="image"
              chooseIcon="pi pi-upload"
              chooseLabel="Browse"
              accept="image/*"
              [auto]="false"
              [customUpload]="true"
              (onSelect)="onImageSelected($event)"
              [showUploadButton]="false"
              [showCancelButton]="false"
              class="custom-file-upload"
            ></p-fileUpload>
          </div>

          <!-- Image Previews -->
          <div class="space-y-4">
            @if (selectedImageUrl) {
            <div>
              <h3 class="text-lg font-medium text-green-800 mb-2">
                New Image Preview
              </h3>
              <div
                class="bg-green-50 rounded-lg border border-green-100 p-4 flex justify-center"
              >
                <img
                  [src]="selectedImageUrl"
                  alt="New Image Preview"
                  class="max-w-full rounded-lg h-48 object-contain"
                />
              </div>
            </div>
            } @if (donation?.photoUrl && !selectedImageUrl) {
            <div>
              <h3 class="text-lg font-medium text-green-800 mb-2">
                Current Image
              </h3>
              @if (imageState === 'loading') {
              <div
                class="bg-green-50 rounded-lg border border-green-100 p-12 flex flex-col items-center justify-center"
              >
                <lucide-icon
                  name="loader"
                  class="h-8 w-8 animate-spin text-green-600"
                ></lucide-icon>
                <p class="mt-2 text-gray-600">Loading image...</p>
              </div>
              } @else if (imageState === 'error') {
              <div
                class="bg-red-50 rounded-lg border border-red-100 p-4 flex flex-col items-center justify-center"
              >
                <lucide-icon
                  name="alert-circle"
                  class="h-8 w-8 text-red-600"
                ></lucide-icon>
                <p class="mt-2 text-red-600">Failed to load image</p>
                <button
                  type="button"
                  class="mt-2 border border-red-600 text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                  (click)="retryLoadImage()"
                >
                  <lucide-icon name="refresh-cw" class="h-4 w-4"></lucide-icon>
                  Retry
                </button>
              </div>
              } @else if (imageState === 'loaded' && imageUrl) {
              <div
                class="bg-green-50 rounded-lg border border-green-100 p-4 flex justify-center"
              >
                <img
                  [src]="imageUrl"
                  alt="Current Donation Image"
                  class="max-w-full rounded-lg h-48 object-contain"
                />
              </div>
              }
            </div>
            }
          </div>
        </div>
      </div>
      <!-- @if (mode == 'create') { -->
      <div>
        <h2
          class="flex items-center gap-2 text-xl font-semibold text-green-700 my-4"
        >
          <lucide-icon
            name="map-icon"
            class="h-5 w-5 text-green-600"
          ></lucide-icon>
          Location Map
        </h2>
        <div
          id="map"
          class="w-full h-64 rounded-lg border border-green-100"
        ></div>
        <input type="text" id="latitude" readonly hidden />
        <input type="text" id="longitude" readonly hidden />
      </div>
      <!-- } -->

      <!-- Form Buttons -->
      <div
        class="flex flex-wrap justify-between items-center gap-4 mt-8 pt-6 border-t border-green-100"
      >
        <button
          type="button"
          class="border border-green-600 text-green-600 hover:bg-green-50 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
          (click)="goBack()"
        >
          <lucide-icon name="arrow-left" class="h-4 w-4"></lucide-icon>
          Back
        </button>

        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors"
          [disabled]="isSubmitting"
        >
          @if (!isSubmitting) {
          <lucide-icon
            [name]="mode === 'create' ? 'plus' : 'save'"
            class="h-4 w-4"
          ></lucide-icon>
          {{ mode === "create" ? "Create Donation" : "Update Donation" }}
          } @else {
          <lucide-icon name="loader" class="h-4 w-4 animate-spin"></lucide-icon>
          {{ mode === "create" ? "Creating..." : "Updating..." }}
          }
        </button>
      </div>
    </form>
  </div>
</div>

<p-toast />
<p-confirmdialog key="global" [focusTrap]="false">
  <ng-template pTemplate="message" let-message>
    <div class="flex items-start gap-2">
      <lucide-icon
        name="alert-triangle"
        class="h-5 w-5 text-yellow-500 mt-1"
      ></lucide-icon>
      <span class="text-gray-700 text-base">{{ message?.message }}</span>
    </div>
  </ng-template>
</p-confirmdialog>
