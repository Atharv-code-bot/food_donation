<div class="page">
  <header>
    <app-header />
  </header>
  <div class="profile-container bg-green-50">
    <app-sidebar></app-sidebar>
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <p-dialog
      header="Edit Your Profile"
      [(visible)]="showEditModal"
      [modal]="true"
      [style]="{ width: '90vw', maxWidth: '600px' }"
      [draggable]="false"
      [resizable]="false"
      styleClass="p-dialog-rounded"
    >
      <div class="p-fluid">
        <form *ngIf="profileForm" [formGroup]="profileForm" class="space-y-5">
          <input type="hidden" formControlName="latitude" />
          <input type="hidden" formControlName="longitude" />
          <div>
            <label class="block text-sm font-semibold text-green-800 mb-2"
              >Full Name</label
            >
            <input
              type="text"
              pInputText
              formControlName="fullname"
              class="w-full p-3 border border-green-200 rounded-lg focus:ring-green-400 focus:border-green-400 transition duration-150 ease-in-out"
              placeholder="Enter your full name"
            />
            <small
              *ngIf="
                profileForm.get('fullname')?.invalid &&
                profileForm.get('fullname')?.touched
              "
              class="p-error block mt-1"
            >
              Full Name is required.
            </small>
          </div>

          <div>
            <label class="block text-sm font-semibold text-green-800 mb-2"
              >Phone Number</label
            >
            <input
              type="text"
              pInputText
              formControlName="phone"
              class="w-full p-3 border border-green-200 rounded-lg focus:ring-green-400 focus:border-green-400 transition duration-150 ease-in-out"
              placeholder="Enter your phone number"
            />
            <small
              *ngIf="
                profileForm.get('phone')?.invalid &&
                profileForm.get('phone')?.touched
              "
              class="p-error block mt-1"
            >
              Phone Number is required.
            </small>
          </div>

          <div>
            <label class="block text-sm font-semibold text-green-800 mb-2"
              >Address</label
            >
            <textarea
              pInputTextarea
              rows="3"
              formControlName="address"
              class="w-full p-3 border border-green-200 rounded-lg focus:ring-green-400 focus:border-green-400 transition duration-150 ease-in-out resize-none"
              placeholder="Enter your address"
            ></textarea>
            <small
              *ngIf="
                profileForm.get('address')?.invalid &&
                profileForm.get('address')?.touched
              "
              class="p-error block mt-1"
            >
              Address is required.
            </small>
            <p-button
              label="Set Default Location"
              icon="pi pi-map"
              styleClass="p-button-success"
              (click)="openMapDialogAndInit()"
              [disabled]="profileForm.invalid"
            ></p-button>
            <span *ngIf="selectedAddress()">
              Selected Location: {{ selectedAddress() }}
            </span>
          </div>

          <div
            class="flex justify-end gap-3 pt-6 border-t border-green-100 mt-6"
          >
            <p-button
              label="Cancel"
              icon="pi pi-times"
              styleClass="p-button-outlined p-button-danger"
              (click)="cancelEdit()"
            ></p-button>
            <p-button
              label="Save Changes"
              icon="pi pi-check"
              styleClass="p-button-success"
              (click)="saveChanges()"
              [disabled]="profileForm.invalid"
            ></p-button>
          </div>
        </form>
      </div>
    </p-dialog>
    <p-dialog
      header="Set Default Location"
      [(visible)]="showMapModal"
      [style]="{ width: '90vw', maxWidth: '800px' }"
      [modal]="true"
      [draggable]="false"
    >
      <div class="flex flex-col h-full">
        <app-map
          [mode]="'set-default-location'"
          mapId="profile-map-editor"
          (coordsChange)="onCoordsChange($event!)"
          class="flex-1"
        ></app-map>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button
          type="button"
          (click)="showMapModal = false; selectedAddress.set(null)"
          class="border border-red-500 text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg"
        >
          Close
        </button>
        <button
          type="button"
          (click)="closeMapDialogAndSave()"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
        >
          OK
        </button>
      </div>
    </p-dialog>
    <div
      id="profile-map-editor"
      style="width: 0; height: 0; overflow: hidden; position: absolute"
    ></div>

    <div class="profile-content max-w-9xl mx-auto space-y-8">
      <h2 class="text-3xl font-bold mb-6 text-green-900 text-center">
        Your Profile
      </h2>

      <div
        class="bg-white rounded-xl shadow-md border border-green-100 p-6 flex flex-col md:flex-row items-center justify-between gap-6"
      >
        <div class="flex flex-col sm:flex-row items-center gap-4">
          <img
            [src]="profileImageUrl"
            class="w-24 h-24 rounded-full object-cover border-4 border-green-300 shadow-md"
            alt="Your Avatar"
          />
          <div class="text-center sm:text-left">
            <p class="text-md text-gray-700 font-semibold mb-1">Welcome,</p>
            <h3 class="text-xl font-bold text-green-800">
              {{ user?.username }}
            </h3>
            <p class="text-sm text-gray-500">
              {{ user?.role?.replace("ROLE_", "") || "User" }}
            </p>
          </div>
        </div>
        <div>
          <input
            type="file"
            (change)="onAvatarSelected($event)"
            hidden
            #avatarInput
          />
          <p-button
            label="Upload New Avatar"
            icon="pi pi-upload"
            styleClass="p-button-outlined p-button-success"
            (click)="avatarInput.click()"
          ></p-button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md border border-green-100 p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-green-800">Basic Information</h3>
          <p-button
            label="Edit Details"
            icon="pi pi-pencil"
            styleClass="p-button-outlined p-button-secondary"
            (click)="openEditModal()"
          ></p-button>
        </div>

        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-8"
        >
          <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1"
              >Username</label
            >
            <div class="profile-value">
              {{ user?.username || "Not provided" }}
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1"
              >Email Address</label
            >
            <div class="profile-value">
              {{ user?.email || "Not provided" }}
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1"
              >Full Name</label
            >
            <div class="profile-value">
              {{ user?.fullname || "Not provided" }}
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1"
              >Phone Number</label
            >
            <div class="profile-value">
              {{ user?.phone || "Not provided" }}
            </div>
          </div>

          <div class="md:col-span-2 lg:col-span-3">
            <label class="block text-sm font-semibold text-gray-600 mb-1"
              >Address</label
            >
            <div class="profile-value">
              {{ user?.address || "Not provided" }}
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md border border-green-100 p-6">
        <h4 class="text-xl font-bold mb-6 text-green-800">Change Password</h4>
        <form
          *ngIf="passwordForm"
          [formGroup]="passwordForm"
          (ngSubmit)="updatePassword()"
          class="space-y-5"
        >
          <input
            type="text"
            name="username"
            autocomplete="username"
            class="hidden"
          />

          <div>
            <label class="block text-sm font-semibold text-green-800 mb-2"
              >Current Password</label
            >
            <input
              type="password"
              pInputText
              formControlName="currentPassword"
              autocomplete="current-password"
              class="w-full p-3 border border-green-200 rounded-lg focus:ring-green-400 focus:border-green-400 transition duration-150 ease-in-out"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-green-800 mb-2"
              >New Password</label
            >
            <input
              type="password"
              pInputText
              formControlName="newPassword"
              autocomplete="new-password"
              class="w-full p-3 border border-green-200 rounded-lg focus:ring-green-400 focus:border-green-400 transition duration-150 ease-in-out"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-green-800 mb-2"
              >Confirm Password</label
            >
            <input
              type="password"
              pInputText
              formControlName="confirmPassword"
              autocomplete="new-password"
              (blur)="checkPasswordMatch()"
              class="w-full p-3 border border-green-200 rounded-lg focus:ring-green-400 focus:border-green-400 transition duration-150 ease-in-out"
            />
            <small *ngIf="passwordMismatch" class="p-error block mt-1"
              >Passwords do not match.</small
            >
          </div>

          <p-button
            type="submit"
            label="{{ isUpdatingPassword ? 'Updating...' : 'Update Password' }}"
            icon="pi pi-key"
            styleClass="p-button-success w-full sm:w-auto"
            [disabled]="
              passwordForm.invalid || passwordMismatch || isUpdatingPassword
            "
          ></p-button>
        </form>
      </div>
    </div>
  </div>
</div>
