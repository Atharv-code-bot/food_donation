<div class="min-h-screen bg-gradient-to-b from-green-50 to-white">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-green-100 p-6">
    <div class="max-w-8xl mx-auto flex justify-between items-center">
      <h1 class="text-2xl md:text-3xl font-bold text-green-800">
        Donation Details
      </h1>
      <div
        class="px-4 py-1 rounded-full text-sm font-medium capitalize"
        [class.bg-green-100]="donation()?.status === 'AVAILABLE'"
        [class.text-green-800]="donation()?.status === 'AVAILABLE'"
        [class.bg-yellow-100]="donation()?.status === 'CLAIMED'"
        [class.text-yellow-800]="donation()?.status === 'CLAIMED'"
        [class.bg-blue-100]="donation()?.status === 'COLLECTED'"
        [class.text-blue-800]="donation()?.status === 'COLLECTED'"
      >
        {{ donation()?.status }}
      </div>
    </div>
  </header>

  <!-- <p-confirmdialog key="global" [focusTrap]="false">
    <ng-template pTemplate="message" let-message>
      <div class="flex items-start gap-2">
        <lucide-icon
          name="alert-triangle"
          class="h-5 w-5 text-yellow-500 mt-1"
        ></lucide-icon>
        <span class="text-gray-700 text-base">{{ message?.message }}</span>
      </div>
    </ng-template>
  </p-confirmdialog> -->

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto p-8">
    <div
      class="bg-white rounded-lg shadow-sm border border-green-100 flex flex-col"
      style="min-height: calc(100vh - 200px)"
    >
      <div class="grid lg:grid-cols-2 gap-8 p-6 flex-grow">
        <!-- Left Column - Details -->
        <div class="space-y-6 h-full">
          <!-- Item Title -->
          <h2 class="text-3xl font-bold text-gray-900 mb-6">
            {{ donation()?.itemName }}
          </h2>

          <!-- Item Details Card -->
          <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
            <h3
              class="flex items-center gap-3 text-xl font-semibold text-green-800 mb-4 pb-2 border-b border-green-100"
            >
              <lucide-icon
                name="package"
                class="h-6 w-6 text-green-600"
              ></lucide-icon>
              Item Details
            </h3>
            <div class="space-y-4 pl-2">
              <div class="flex items-center">
                <span class="w-40 text-lg font-medium text-gray-600"
                  >Quantity</span
                >
                <span
                  class="px-4 py-2 bg-gray-50 rounded-md text-gray-800 font-medium"
                  >
                  {{ donation()?.quantity }}
                  {{ donation()?.quantityUnitLabel }}
                  </span
                >
              </div>
              <div class="flex items-center">
                <span class="w-40 text-lg font-medium text-gray-600"
                  >Best Before</span
                >
                <span class="px-4 py-2 bg-gray-50 rounded-md text-gray-800">
                  {{ donation()?.bestBeforeDate | date : "fullDate" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Pickup Details Card -->
          <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
            <h3
              class="flex items-center gap-3 text-xl font-semibold text-green-800 mb-4 pb-2 border-b border-green-100"
            >
              <lucide-icon
                name="map-pin"
                class="h-6 w-6 text-green-600"
              ></lucide-icon>
              Pickup Details
            </h3>
            <div class="space-y-4 pl-2">
              <div class="flex items-center">
                <span class="w-40 text-lg font-medium text-gray-600"
                  >Location</span
                >
                <span class="px-4 py-2 bg-gray-50 rounded-md text-gray-800">{{
                  donation()?.pickupLocation
                }}</span>
              </div>
              <div class="flex items-center">
                <span class="w-40 text-lg font-medium text-gray-600"
                  >Available From</span
                >
                <span class="px-4 py-2 bg-gray-50 rounded-md text-gray-800">
                  {{ donation()?.availabilityStart | date : "fullDate" }}
                </span>
              </div>
              <div class="flex items-center">
                <span class="w-40 text-lg font-medium text-gray-600"
                  >Available Until</span
                >
                <span class="px-4 py-2 bg-gray-50 rounded-md text-gray-800">
                  {{ donation()?.availabilityEnd | date : "fullDate" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Reference Information -->
          <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
            <h3
              class="flex items-center gap-3 text-xl font-semibold text-green-800 mb-4 pb-2 border-b border-green-100"
            >
              <lucide-icon
                name="info"
                class="h-6 w-6 text-green-600"
              ></lucide-icon>
              Reference Information
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pl-2">
              <div class="flex items-center">
                <span class="w-40 text-lg font-medium text-gray-600"
                  >Donation ID</span
                >
                <span class="px-4 py-2 bg-gray-50 rounded-md text-gray-800">{{
                  donation()?.donationId
                }}</span>
              </div>
              <div class="flex items-center">
                <span class="w-40 text-lg font-medium text-gray-600"
                  >Donor ID</span
                >
                <span class="px-4 py-2 bg-gray-50 rounded-md text-gray-800">{{
                  donation()?.donorId
                }}</span>
              </div>
              <div
                *ngIf="donation()?.status != 'AVAILABLE'"
                class="flex items-center"
              >
                <span class="w-40 text-lg font-medium text-gray-600"
                  >NGO ID</span
                >
                <span class="px-4 py-2 bg-gray-50 rounded-md text-gray-800">{{
                  donation()?.ngoId
                }}</span>
              </div>
            </div>
          </div>

          <!-- Timestamps -->
          <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
            <div class="space-y-3 text-gray-700">
              <div class="flex items-center gap-3">
                <lucide-icon
                  name="calendar-plus"
                  class="h-5 w-5 text-green-600"
                ></lucide-icon>
                <span class="">
                  <span class="font-medium">Created:</span>
                  {{ donation()?.createdAt | date : "fullDate" }}
                </span>
              </div>
              <div class="flex items-center gap-3">
                <lucide-icon
                  name="calendar-check"
                  class="h-5 w-5 text-green-600"
                ></lucide-icon>
                <span class="">
                  <span class="font-medium">Updated:</span>
                  {{ donation()?.updatedAt | date : "fullDate" }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Visuals -->
        <div class="space-y-6">
          <!-- Image Preview -->
          <div>
            <h3
              class="flex items-center gap-2 text-xl font-semibold text-green-700 mb-6"
            >
              <lucide-icon
                name="image"
                class="h-5 w-5 text-green-600"
              ></lucide-icon>
              Donation Image
            </h3>
            <div
              class="bg-green-0 rounded-lg flex justify-center p-4 border border-green-100 overflow-hidden"
            >
              @if (imageUrl) {
              <div
                class="group relative cursor-pointer"
                (click)="openImageModal()"
              >
                <img
                  [src]="imageUrl"
                  alt="Donation Image"
                  class="w-96 rounded-lg object-contain hover:opacity-90 transition-opacity"
                />
                <div
                  class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <div
                    class="bg-black bg-opacity-50 text-white px-3 py-1 rounded text-sm"
                  >
                    Click to enlarge
                  </div>
                </div>
              </div>
              } @else {
              <div
                class="h-64 flex flex-col items-center justify-center text-gray-400 bg-green-50"
              >
                <lucide-icon name="image" class="h-12 w-12"></lucide-icon>
                <p class="mt-2 mx-4">No Image Available</p>
              </div>
              }
            </div>
          </div>

          <!-- Map -->
          <app-map
            [mode]="'view'"
            [mapId]="'donationMap'"
            [donationData]="donation()"
          ></app-map>
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex flex-wrap gap-3 p-6 border-t border-green-100">
        <p-toast />
        <p-confirmdialog key="global" [focusTrap]="false">
          <ng-template pTemplate="message" let-message>
            <div class="flex items-start gap-2">
              <lucide-icon
                name="alert-triangle"
                class="h-5 w-5 text-yellow-500 mt-1"
              ></lucide-icon>
              <span class="text-gray-700 text-base">{{
                message?.message
              }}</span>
            </div>
          </ng-template>
        </p-confirmdialog>

        @if (role === 'ROLE_DONOR' && donation()?.status === 'AVAILABLE') {
        <button
          [routerLink]="['update']"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
        >
          <lucide-icon name="edit" class="h-4 w-4"></lucide-icon>
          Update
        </button>
        <button
          class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
          [disabled]="isSubmittingDelete"
          (click)="confirmDelete($event, donationId)"
        >
          @if (!isSubmittingDelete) {
          <lucide-icon name="trash-2" class="h-4 w-4"></lucide-icon>
          Delete } @else {
          <lucide-icon name="loader" class="h-4 w-4 animate-spin"></lucide-icon>
          Deleting... }
        </button>
        } @else if (role === 'ROLE_NGO') { @if (donation()?.status ===
        'AVAILABLE') {
        <button
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
          [disabled]="isSubmittingClaim"
          (click)="confirmClaimDonation($event)"
        >
          @if (!isSubmittingClaim) {
          <lucide-icon name="handshake" class="h-4 w-4"></lucide-icon>
          Claim } @else {
          <lucide-icon name="loader" class="h-4 w-4 animate-spin"></lucide-icon>
          Claiming... }
        </button>
        } @else if (donation()?.status === 'CLAIMED') { @if
        (!donationSuccessfullyCompleted()) { @if (!isOtpSent) {
        <button
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
          [disabled]="isSubmittingOtp"
          (click)="sendOtp()"
        >
          @if (!isSubmittingOtp) {
          <lucide-icon name="mail" class="h-4 w-4"></lucide-icon>
          Request OTP } @else {
          <lucide-icon name="loader" class="h-4 w-4 animate-spin"></lucide-icon>
          Sending... }
        </button>
        } @else {
        <div class="space-y-4 w-full">
          <p class="text-gray-600 text-center">
            Please enter the OTP sent to your phone.
          </p>

          <p-inputotp
            [(ngModel)]="otpValue"
            [integerOnly]="true"
            [length]="6"
            [mask]="true"
            class="w-full justify-center"
            inputClass="w-10 h-10 mx-1 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-400"
          >
          </p-inputotp>

          <div class="flex justify-between items-center">
            <button
              type="button"
              class="text-blue-600 hover:text-blue-800 text-sm"
              [disabled]="!canResend"
              (click)="sendOtp()"
            >
              @if (!canResend) { Resend in {{ resendCountdown }}s } @else {
              Resend OTP }
            </button>

            <button
              type="button"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
              [disabled]="!otpValue || isSubmittingComplete"
              (click)="confirmCompleteDonation($event)"
            >
              @if (!isSubmittingComplete) {
              <lucide-icon name="check" class="h-4 w-4"></lucide-icon>
              Submit Code } @else {
              <lucide-icon
                name="loader"
                class="h-4 w-4 animate-spin"
              ></lucide-icon>
              Completing... }
            </button>
          </div>
        </div>
        } } @else {
        <div
          class="p-4 rounded-lg bg-green-100 text-green-800 text-lg font-semibold text-center w-full"
        >
          🎉 Donation successfully marked as collected!
        </div>
        } } @else if (donation()?.status === 'COLLECTED') {
        <div
          class="p-4 rounded-lg bg-green-100 text-green-800 text-lg font-semibold text-center w-full"
        >
          ✅ This donation has already been collected.
        </div>
        } }
        <button
          (click)="goBack()"
          class="border border-green-600 text-green-600 hover:bg-green-50 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
        >
          <lucide-icon name="arrow-left" class="h-4 w-4"></lucide-icon>
          Back
        </button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div
    *ngIf="showImageModal"
    class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
    (click)="closeImageModal()"
  >
    <div
      class="relative max-w-3xl w-full bg-white rounded-lg p-4"
      (click)="$event.stopPropagation()"
    >
      <button
        class="absolute -top-3 -right-3 bg-white rounded-full p-1 shadow-md hover:bg-green-50 transition-colors"
        (click)="closeImageModal()"
      >
        <lucide-icon name="x" class="h-6 w-6 text-gray-700"></lucide-icon>
      </button>
      <div class="flex flex-col items-center">
        <h3 class="text-xl font-semibold text-green-700 mb-2">
          Donation Image Preview
        </h3>
        <img
          [src]="imageUrl || '/assets/placeholder.svg'"
          alt="Enlarged Donation Image"
          class="max-w-xl max-h-[70vh] object-contain rounded-lg"
        />
        <p class="text-sm text-gray-500 mt-2">
          Click outside the image to close
        </p>
      </div>
    </div>
  </div>
</div>
